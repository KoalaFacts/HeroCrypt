name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  CI: true

jobs:
  create-release:
    name: Create Release v${{ inputs.version }}
    runs-on: ubuntu-latest

    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            exit 1
          fi
          echo "Version validated: $VERSION"

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract build configuration
        id: config
        uses: ./.github/actions/extract-build-config

      - name: Setup .NET SDKs
        uses: ./.github/actions/setup-dotnet-sdks
        with:
          dotnet-version: ${{ steps.config.outputs.versions }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Release
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ inputs.version }}"
          DATE=$(date +%Y-%m-%d)

          # Insert new version entry after "# Changelog" title
          sed -i "/# Changelog/a\\\\n## [$VERSION] - $DATE\\n\\nSee [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v$VERSION) for details.\\n" CHANGELOG.md

          echo "Updated CHANGELOG.md with version $VERSION"

          # Commit the CHANGELOG update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: release v$VERSION [skip ci]"

          # Pull any new changes before pushing
          git pull --rebase origin main
          git push

          echo "CHANGELOG.md committed and pushed"

      - name: Pack NuGet packages
        run: |
          dotnet pack src/HeroCrypt/HeroCrypt.csproj \
            --configuration Release \
            -p:PackageVersion=${{ inputs.version }} \
            -p:Version=${{ inputs.version }}

      - name: Verify packages were created
        run: |
          if [ ! -f "src/HeroCrypt/bin/Release/HeroCrypt.${{ inputs.version }}.nupkg" ]; then
            echo "Error: Main package not found"
            exit 1
          fi
          if [ ! -f "src/HeroCrypt/bin/Release/HeroCrypt.${{ inputs.version }}.snupkg" ]; then
            echo "Error: Symbol package not found"
            exit 1
          fi
          echo "Packages verified:"
          ls -lh src/HeroCrypt/bin/Release/HeroCrypt.${{ inputs.version }}.*

      - name: Install Microsoft SBOM tool
        run: dotnet tool install --global Microsoft.Sbom.DotNetTool

      - name: Generate SBOMs
        run: |
          mkdir -p release-sboms

          # Generate SBOMs for each framework and SPDX version
          for framework in net8.0 net9.0 net10.0; do
            for spdx_version in 2.2 3.0; do
              echo "Generating SBOM for $framework, SPDX $spdx_version..."

              mkdir -p sbom-output-$framework-$spdx_version

              sbom-tool generate \
                -b src/HeroCrypt/bin/Release/$framework \
                -bc src/HeroCrypt \
                -pn HeroCrypt \
                -pv ${{ inputs.version }} \
                -ps KoalaFacts \
                -nsb https://github.com/${{ github.repository }} \
                -mi SPDX:$spdx_version \
                -m sbom-output-$framework-$spdx_version \
                -V Verbose

              # Find and copy SBOM file
              SBOM_FILE=$(find sbom-output-$framework-$spdx_version -type f -name "*.spdx.json" | head -n 1)
              if [ -n "$SBOM_FILE" ]; then
                cp "$SBOM_FILE" release-sboms/HeroCrypt.${{ inputs.version }}.$framework.spdx-$spdx_version.json
                echo "Created: HeroCrypt.${{ inputs.version }}.$framework.spdx-$spdx_version.json"
              else
                echo "Error: No SBOM file found for $framework SPDX $spdx_version"
                exit 1
              fi
            done
          done

          echo "All SBOMs generated:"
          ls -lh release-sboms/

      - name: Create release description footer
        id: release-notes
        run: |
          VERSION="${{ inputs.version }}"
          REPO="${{ github.repository }}"

          # Create footer with installation and package info using echo
          {
            echo ""
            echo "---"
            echo ""
            echo "### Installation"
            echo "\`\`\`bash"
            echo "dotnet add package HeroCrypt --version ${VERSION}"
            echo "\`\`\`"
            echo ""
            echo "### Package Details"
            echo "- **NuGet**: [HeroCrypt v${VERSION}](https://www.nuget.org/packages/HeroCrypt/${VERSION})"
            echo "- **Frameworks**: netstandard2.0, net8.0, net9.0, net10.0"
            echo "- **Dependencies**: Microsoft.Bcl.Memory (netstandard2.0, net8.0)"
            echo ""
            echo "### Security & Compliance"
            echo "- RFC 9106 (Argon2): Fully compliant"
            echo "- RFC 7693 (Blake2b): Fully compliant"
            echo "- RFC 8439 (ChaCha20-Poly1305): Fully compliant"
            echo "- RFC 7748 (Curve25519): Fully compliant"
            echo ""
            echo "### SBOMs (Software Bill of Materials)"
            echo "Per-framework SBOMs included in this release:"
            echo "- SPDX 2.2 format (net8.0, net9.0, net10.0)"
            echo "- SPDX 3.0 format (net8.0, net9.0, net10.0)"
            echo ""
            echo "### Documentation"
            echo "- [README](https://github.com/${REPO}/blob/main/README.md)"
            echo "- [Full Changelog](https://github.com/${REPO}/blob/main/CHANGELOG.md)"
          } > release-footer.md

          echo "Release footer created with installation and package details"

      - name: Generate release notes (auto + footer)
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v${VERSION}"

          # Generate GitHub release notes body
          gh api repos/${{ github.repository }}/releases/generate-notes \
            -f tag_name="${TAG}" \
            -f target_commitish="${GITHUB_SHA}" \
            --jq .body > auto-notes.md

          # Combine auto-notes with footer
          cat auto-notes.md release-footer.md > release-notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        run: |
          echo "Creating release v${{ inputs.version }}..."

          gh release create v${{ inputs.version }} \
            --title "Release v${{ inputs.version }}" \
            --notes-file release-notes.md \
            src/HeroCrypt/bin/Release/HeroCrypt.${{ inputs.version }}.nupkg \
            src/HeroCrypt/bin/Release/HeroCrypt.${{ inputs.version }}.snupkg \
            release-sboms/*.json

          echo "Release created with auto-generated notes and published!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify release was created
        run: |
          echo "Verifying release v${{ inputs.version }}..."
          gh release view v${{ inputs.version }} --json assets --jq '.assets[].name'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL**: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Published" >> $GITHUB_STEP_SUMMARY
          echo "**NuGet Packages:**" >> $GITHUB_STEP_SUMMARY
          echo "- HeroCrypt.${{ inputs.version }}.nupkg" >> $GITHUB_STEP_SUMMARY
          echo "- HeroCrypt.${{ inputs.version }}.snupkg (symbols)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SBOMs (Software Bill of Materials):**" >> $GITHUB_STEP_SUMMARY
          echo "- 6 SBOMs total (3 frameworks Ã— 2 SPDX formats)" >> $GITHUB_STEP_SUMMARY
          echo "- Per-framework dependency tracking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The publish-nuget workflow will automatically trigger to publish packages to NuGet.org" >> $GITHUB_STEP_SUMMARY
run-name: Create Release v${{ inputs.version }}
